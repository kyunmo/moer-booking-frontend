# 백엔드 작업 완료 - Booking 고객 API (2026-02-21)

> **작업일:** 2026-02-21
> **요청 문서:** `docs/백엔드-요청사항-booking-2026-02-21.md`
> **빌드 상태:** BUILD SUCCESSFUL

---

## 작업 결과 요약

| # | 항목 | 우선순위 | 상태 | 변경 내용 |
|---|------|---------|------|----------|
| 1 | 고객 예약 목록 API | P0 | ✅ 이미 구현됨 | 변경 없음 (아래 상세 스펙 참고) |
| 2 | 매장 상세 slug/ID 지원 | P0 | ✅ 수정 완료 | slugOrId 자동 판별 로직 추가 |
| 3 | 고객 인증 예약 생성 후 연결 | P1 | ✅ 이미 구현됨 | userId 자동 연결 확인 완료 |
| 4 | 기존 고객 API 엔드포인트 확인 | P2 | ✅ 전체 확인 완료 | 모든 엔드포인트 정상 |

---

## 1. [P0] 고객 예약 목록 API (이미 구현됨)

### 엔드포인트
```
GET /api/customer/reservations
Authorization: Bearer {customerAccessToken}
```

### Query Parameters

| 파라미터 | 타입 | 필수 | 기본값 | 설명 |
|---------|------|------|-------|------|
| status | String | N | 전체 | 상태 필터: `PENDING`, `CONFIRMED`, `COMPLETED`, `CANCELLED`, `NO_SHOW` |
| page | Number | N | 1 | 페이지 번호 (1-based) |
| size | Number | N | 10 | 페이지 크기 |

### 응답 형식

```json
{
  "success": true,
  "data": {
    "content": [
      {
        "reservationNumber": "260221-A3B9",
        "status": "CONFIRMED",
        "businessName": "모어 헤어살롱",
        "businessSlug": "moer-hair",
        "businessProfileImageUrl": "https://...",
        "reservationDate": "2026-03-01",
        "startTime": "14:00",
        "endTime": "15:00",
        "staffId": 1,
        "staffName": "김직원",
        "services": [{"id": 1, "name": "커트", "price": 30000}],
        "totalPrice": 50000,
        "canCancel": true,
        "hasReview": false,
        "createdAt": "2026-02-21T10:00:00"
      }
    ],
    "totalElements": 5,
    "totalPages": 1,
    "page": 1,
    "size": 10
  }
}
```

### 응답 필드 상세

| 필드 | 타입 | 설명 |
|------|------|------|
| reservationNumber | String | 예약번호 (예: 260221-A3B9) |
| status | String | 예약 상태: PENDING/CONFIRMED/COMPLETED/CANCELLED/NO_SHOW |
| businessName | String | 매장명 |
| businessSlug | String? | 매장 슬러그 (null일 수 있음 → 이 경우 ID 사용) |
| businessProfileImageUrl | String? | 매장 프로필 이미지 URL (nullable) |
| reservationDate | String | 예약일 (yyyy-MM-dd) |
| startTime | String | 시작 시간 (HH:mm) |
| endTime | String | 종료 시간 (HH:mm) |
| staffId | Number? | 담당자 ID (nullable, 재예약용) |
| staffName | String? | 담당자명 (nullable) |
| services | Array | 서비스 목록 (`{id, name, price}` 객체 배열 또는 문자열 배열) |
| totalPrice | Number | 총 금액 (원) |
| canCancel | Boolean | 취소 가능 여부 |
| hasReview | Boolean | 리뷰 작성 여부 |
| createdAt | String | 예약 생성일시 (ISO 8601) |

### 프론트엔드 참고사항
- **services 필드**: `List<Map<String, Object>>` 타입으로, DB JSONB에서 직접 반환됩니다
  - 보통 `[{id: 1, name: "커트", price: 30000, duration: 60}]` 형태
  - 안전하게 처리하려면 문자열/객체 양쪽 대응 필요
- **인증**: JWT 토큰에서 userId를 추출하여 해당 사용자의 예약만 반환
- **구현 위치**: `CustomerBookingController.java` → `CustomerBookingService.getMyReservations()`

---

## 2. [P0] 매장 상세 slug/ID 양쪽 지원 (수정 완료)

### 엔드포인트
```
GET /api/public/businesses/{slugOrId}
```

### 변경 내용
- 기존: slug(문자열)로만 조회 가능
- **변경 후**: slugOrId 자동 판별
  - 숫자 → ID로 우선 조회, 미존재 시 slug로 fallback
  - 문자열 → slug로 조회

### 사용 예시
```
# slug로 조회
GET /api/public/businesses/moer-hair

# ID로 조회 (slug 미설정 매장)
GET /api/public/businesses/123
```

### 프론트엔드 대응
```javascript
// 프론트에서 이미 처리 완료된 패턴
const identifier = business.slug || business.id;
router.push(`/businesses/${identifier}`);
```

### 응답 형식

```json
{
  "success": true,
  "data": {
    "id": 1,
    "slug": "moer-hair",
    "name": "모어 헤어살롱",
    "businessType": "BEAUTY_SHOP",
    "description": "설명...",
    "address": "서울시 강남구...",
    "addressDetail": "2층 201호",
    "zipCode": "06234",
    "phone": "02-1234-5678",
    "profileImageUrl": "https://...",
    "galleryImages": ["https://..."],
    "averageRating": 4.5,
    "reviewCount": 23,
    "businessHours": {
      "mon": {"open": "09:00", "close": "20:00"},
      "tue": {"open": "09:00", "close": "20:00"},
      "wed": {"open": "09:00", "close": "20:00"},
      "thu": {"open": "09:00", "close": "20:00"},
      "fri": {"open": "09:00", "close": "20:00"},
      "sat": {"open": "10:00", "close": "18:00"},
      "sun": null
    },
    "tags": ["헤어", "염색"],
    "services": [
      {
        "id": 1,
        "categoryName": "헤어",
        "name": "커트",
        "description": "기본 커트",
        "price": 30000,
        "duration": 60
      }
    ],
    "staffs": [
      {
        "id": 1,
        "name": "김직원",
        "position": "디자이너",
        "profileImageUrl": "https://...",
        "introduction": "10년 경력",
        "specialty": "펌, 염색",
        "portfolioCount": 5
      }
    ],
    "createdAt": "2026-01-15 10:00:00"
  }
}
```

---

## 3. [P1] 고객 인증 예약 생성 - 고객 연결 확인 (이미 구현됨)

### 엔드포인트
```
POST /api/customer/businesses/{slug}/reservations
Authorization: Bearer {customerAccessToken}
```

### 동작 방식
1. JWT에서 `userId` 추출
2. userId로 `User` 조회 → name, phone, email 자동 사용
3. businessId + userId로 기존 `Customer` 레코드 찾기
4. 없으면 phone으로 기존 고객 찾기 → userId 연결
5. 모두 없으면 신규 `Customer` 생성
6. 예약 생성 시 `customerId` 자동 연결
7. 이후 `GET /api/customer/reservations`에서 조회 가능

### 요청 바디

```json
{
  "serviceIds": [1, 2],
  "staffId": 1,
  "reservationDate": "2026-03-01",
  "startTime": "14:00",
  "customerRequest": "이전과 같은 스타일로 부탁드립니다"
}
```

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| serviceIds | Number[] | Y | 서비스 ID 목록 |
| staffId | Number | N | 담당 스태프 ID (미지정 시 자동 배정) |
| reservationDate | String | Y | 예약일 (yyyy-MM-dd) |
| startTime | String | Y | 시작 시간 (HH:mm) |
| customerRequest | String | N | 고객 요청사항 |

### 응답

```json
{
  "success": true,
  "data": {
    "reservationNumber": "260301-X7K2",
    "status": "PENDING",
    "reservationDate": "2026-03-01",
    "startTime": "14:00",
    "endTime": "15:30",
    "message": "예약이 접수되었습니다. 매장 확인 후 확정됩니다."
  }
}
```

### 프론트엔드 참고사항
- **이름/전화번호/이메일 불필요**: JWT에서 사용자 정보 자동 추출
- **전화번호 필수**: 사용자 프로필에 전화번호가 등록되어 있어야 함
  - 미등록 시 에러 → `"전화번호가 등록되어 있지 않습니다"` 메시지 반환
  - 프론트에서 프로필 수정으로 유도 필요

---

## 4. [P2] 기존 고객 API 엔드포인트 동작 확인

### 전체 엔드포인트 현황

| 엔드포인트 | 메서드 | 설명 | 상태 | 비고 |
|-----------|--------|------|------|------|
| `/api/customer/reservations` | GET | 내 예약 목록 | ✅ 정상 | 페이징+상태필터 |
| `/api/customer/reservations/{reservationNumber}` | GET | 예약 상세 | ✅ 정상 | userId 기반 본인 확인 |
| `/api/customer/reservations/{reservationNumber}/cancel` | POST | 예약 취소 | ✅ 정상 | reason 선택적 |
| `/api/customer/profile` | GET | 프로필 조회 | ✅ 정상 | - |
| `/api/customer/profile` | PATCH | 프로필 수정 | ✅ 정상 | - |
| `/api/customer/businesses/{slug}/reservations` | POST | 예약 생성 | ✅ 정상 | 자동 고객 연결 |
| `/api/customer/businesses/{slug}/reviews` | POST | 리뷰 작성 | ✅ 정상 | reservationNumber 필수 |

### 예약 취소 API 상세

```
POST /api/customer/reservations/{reservationNumber}/cancel
Authorization: Bearer {customerAccessToken}
```

```json
// Request Body (선택적)
{
  "reason": "일정이 변경되었습니다"
}

// Response
{
  "success": true,
  "data": null
}
```

- **본인 확인**: JWT userId 기반 (전화번호 불필요)
- **취소 가능 조건**: `canCancel` 필드가 true인 예약만 취소 가능
  - PENDING, CONFIRMED 상태만 취소 가능
  - COMPLETED, CANCELLED, NO_SHOW 상태는 취소 불가

### 리뷰 작성 API 상세

```
POST /api/customer/businesses/{slug}/reviews
Authorization: Bearer {customerAccessToken}
```

```json
// Request Body
{
  "reservationNumber": "260221-A3B9",
  "rating": 5,
  "content": "서비스가 정말 좋았습니다!",
  "staffId": 1
}
```

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| reservationNumber | String | Y | 예약번호 (COMPLETED + 미리뷰 예약만) |
| rating | Number | Y | 별점 (1~5) |
| content | String | N | 리뷰 내용 |
| staffId | Number | N | 담당 스태프 ID |

---

## 변경 파일 목록

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `PublicBusinessService.java` | 수정 | `getBusinessDetail(slug)` → `getBusinessDetail(slugOrId)` 변경, `findBusinessBySlugOrId()` 추가 |
| `PublicBusinessController.java` | 수정 | `/{slug}` → `/{slugOrId}` 변경, Swagger 설명 업데이트 |

---

## 프론트엔드 체크리스트

- [x] `GET /api/customer/reservations` → 페이징 응답 처리 (content, totalElements, page, size)
- [x] `services` 필드 → 객체 배열 `[{id, name, price}]` 형태로 파싱
- [x] `businessSlug` null → `business.id`로 fallback하여 매장 링크 생성
- [x] `canCancel` 필드로 취소 버튼 표시/숨김
- [x] `hasReview` 필드로 리뷰 작성 버튼 표시/숨김
- [x] 예약 생성 시 전화번호 미등록 에러 핸들링 → 프로필 수정 유도
- [x] slug 없는 매장 → ID fallback 처리 (매장 상세 조회)
