# 백엔드 작업 완료 보고 - P0~P2 (2026-02-22)

> 요청사항: [백엔드-요청사항-P0-P2-2026-02-22.md](./백엔드-요청사항-P0-P2-2026-02-22.md)

---

## 작업 요약

| # | 우선순위 | 작업 | 상태 | 비고 |
|---|---------|------|------|------|
| 1 | P1 | 프로덕션 CORS/OAuth 환경변수 설정 | **완료** | WebConfig 하드코딩 수정 |
| 2 | P1 | VIP 임계값 컬럼 추가 | **완료** | vip_spend_threshold 추가 |
| 3 | P1 | 주소 상세 컬럼 추가 | **이미 구현됨** | address_detail, zip_code 존재 |
| 4 | P0 | 환불 일할계산 금액 확인 | **완료** | 일할계산 로직 구현 |
| 5 | P2 | 예약 일괄 상태 변경 API | **이미 구현됨** | 엔드포인트 경로 확인 필요 |
| 6 | P2 | 통계 자동 새로고침 관련 | **확인 완료** | rate limiting 없음 |
| 7 | 미진행 | 법률 문서 메타정보 | **대기** | 사업자 정보 제공 대기 |

---

## 1. [P1] 프로덕션 CORS/OAuth 환경변수 설정

### 변경 파일
- `src/main/java/io/moer/booking/common/config/WebConfig.java`

### 변경 내용

**문제**: WebConfig에 CORS 허용 origin이 `http://localhost:5173`으로 하드코딩되어 있어 프로덕션 환경에서 CORS 에러 발생 가능

**수정 전**:
```java
.allowedOrigins("http://localhost:5173") // Vite 개발 서버
```

**수정 후**:
```java
@Value("${app.cors.allowed-origins:http://localhost:8080,http://localhost:5173}")
private String allowedOrigins;

// ...
.allowedOrigins(allowedOrigins.split(","))
```

### 프로덕션 배포 시 환경변수

SecurityConfig와 WebConfig 모두 동일한 `app.cors.allowed-origins` 환경변수를 사용하도록 통일됨.

```env
# CORS
CORS_ALLOWED_ORIGINS=https://yemo.kr,https://www.yemo.kr

# OAuth2 Redirect URI (프론트엔드)
OAUTH2_REDIRECT_URI=https://yemo.kr/oauth2-redirect
OAUTH2_CUSTOMER_REDIRECT_URI=https://yemo.kr/oauth2-redirect

# JWT (프로덕션 시크릿)
JWT_SECRET=[프로덕션-시크릿-최소-256비트]
```

### OAuth Provider별 등록 필요 (외부 설정)

| Provider | 프로덕션 Redirect URI |
|----------|----------------------|
| 카카오 | `https://yemo.kr/login/oauth2/code/kakao` |
| 네이버 | `https://yemo.kr/login/oauth2/code/naver` |
| 구글 | `https://yemo.kr/login/oauth2/code/google` |

> OAuth redirect-uri는 `{baseUrl}/login/oauth2/code/{registrationId}` 패턴을 사용하므로 Spring이 요청의 base URL에서 자동 해석합니다. 별도 환경변수 설정 불필요.

---

## 2. [P1] VIP 임계값 컬럼 추가

### 현황 분석

| 요청 컬럼 | 현재 상태 | 작업 |
|-----------|----------|------|
| `vip_visit_threshold` | `business_settings.vip_threshold` (INTEGER, 기본 10) | **이미 존재** |
| `vip_spend_threshold` | 미존재 | **신규 추가** |

### DB 스키마 변경

```sql
ALTER TABLE business_settings
  ADD COLUMN vip_spend_threshold DECIMAL(10,2) DEFAULT 500000;
```

### 변경된 파일 (6개)

| 파일 | 변경 내용 |
|------|----------|
| `resources/db/schema.sql` | `vip_spend_threshold DECIMAL(10,2) DEFAULT 500000` 추가 |
| `domain/business/BusinessSettings.java` | `vipSpendThreshold` 필드 + 헬퍼 메서드 추가 |
| `resources/mapper/business/BusinessSettingsMapper.xml` | ResultMap, UPDATE에 컬럼 추가 |
| `domain/business/dto/CustomerTierSettingsRequest.java` | `vipSpendThreshold` 필드 추가 (@DecimalMin 검증) |
| `domain/business/dto/CustomerTierSettingsResponse.java` | `vipSpendThreshold` 필드 추가 (기본값 500000) |
| `domain/business/service/BusinessService.java` | 조회/수정 메서드에 vipSpendThreshold 반영 |

### API 영향

**GET /api/businesses/{id}/settings/customer-tiers** 응답:
```json
{
  "regularThreshold": 3,
  "vipThreshold": 10,
  "vipSpendThreshold": 500000.00,
  "vipBenefitDescription": ""
}
```

**PUT /api/businesses/{id}/settings/customer-tiers** 요청:
```json
{
  "regularThreshold": 3,
  "vipThreshold": 10,
  "vipSpendThreshold": 300000,
  "vipBenefitDescription": "VIP 10% 할인"
}
```

---

## 3. [P1] 주소 상세 컬럼 추가 - 이미 구현됨

### 확인 결과

| 요청 컬럼 | DB 컬럼 | 엔티티 필드 | API 포함 |
|-----------|---------|------------|---------|
| `address_detail` | `businesses.address_detail` VARCHAR(200) | `Business.addressDetail` | GET/PATCH 포함 |
| `zipcode` | `businesses.zip_code` VARCHAR(10) | `Business.zipCode` | GET/PATCH 포함 |

**추가 작업 불필요** - 두 필드 모두 Entity, DTO, Mapper, Service, Controller에 완전히 반영되어 있음.

---

## 4. [P0] 환불 일할계산 금액 확인/수정

### 이전 상태

| 항목 | 상태 |
|------|------|
| 일할 계산 로직 | **미구현** (전액 환불만 지원) |
| 결제 저장 금액 | 공급가 18,000원 (`amount` 필드) |
| VAT 포함 여부 | **미포함** (19,800원 아닌 18,000원 저장) |

### 변경 내용

**변경 파일**: `domain/payment/service/PaymentService.java`

**일할계산 공식**:
```
환불금액 = finalAmount × (잔여일수 / 총일수)
```

- `finalAmount`: 실제 결제 금액 (할인 적용 후)
- `잔여일수`: 오늘 ~ 청구종료일
- `총일수`: 청구시작일 ~ 청구종료일

**구현된 로직**:
```java
private int calculateProRataRefund(Payment payment) {
    LocalDate today = LocalDate.now();
    LocalDate start = payment.getBillingPeriodStart();
    LocalDate end = payment.getBillingPeriodEnd();

    // 결제 당일 환불 → 전액
    if (!today.isAfter(start)) return payment.getFinalAmount();

    // 청구 기간 만료 후 → 환불 불가
    if (!today.isBefore(end)) return 0;

    // 일할 계산 (반올림)
    long totalDays = ChronoUnit.DAYS.between(start, end);
    long remainingDays = ChronoUnit.DAYS.between(today, end);
    return (int) Math.round((double) payment.getFinalAmount() * remainingDays / totalDays);
}
```

### 환불 예시 (월간 30일 기준)

| 사용 기간 | 잔여일 | 현재 (18,000원 기준) | PG 연동 후 (19,800원 기준) |
|----------|--------|---------------------|---------------------------|
| 10일 | 20일 | 12,000원 | **13,200원** |
| 20일 | 10일 | 6,000원 | **6,600원** |
| 25일 | 5일 | 3,000원 | **3,300원** |
| 당일 | 30일 | 18,000원 (전액) | **19,800원 (전액)** |

### ⚠️ VAT 관련 확인 필요

| 항목 | 현재 상태 | 프로덕션 필요 |
|------|----------|-------------|
| `SubscriptionPlan.monthlyPrice` | 18,000 (공급가) | - |
| `Payment.amount` | 18,000 (공급가 저장) | VAT 포함 19,800으로 저장 권장 |
| `Payment.finalAmount` | 18,000 - 할인 | VAT 포함 금액 기준 |

> **결론**: 일할계산 로직은 `finalAmount`(실제 결제 금액) 기준으로 동작합니다.
> 프로덕션 PG 연동 시 VAT 포함 금액(19,800원)이 `finalAmount`로 저장되면 요청사항의 환불 예시와 정확히 일치합니다.
> 현재 FakePG에서는 공급가(18,000원)로 저장되므로, 실제 PG 연동 시 결제 금액 저장 부분도 함께 수정이 필요합니다.

---

## 5. [P2] 예약 일괄 상태 변경 API - 이미 구현됨

### 기존 엔드포인트

```
PATCH /api/businesses/{businessId}/reservations/bulk-status
```

### ⚠️ 프론트엔드와 경로 차이 확인 필요

| 항목 | FE 예상 | BE 실제 |
|------|---------|---------|
| 엔드포인트 | `PATCH /api/reservations/bulk-status` | `PATCH /api/businesses/{businessId}/reservations/bulk-status` |

> FE에서 `businessId`를 경로에 포함하여 호출하도록 확인 필요

### 요청 형식

```json
{
  "reservationIds": [1, 2, 3],
  "status": "CONFIRMED"
}
```

**지원 상태**: `CONFIRMED`, `COMPLETED`, `CANCELLED`

### 응답 형식

```json
{
  "success": [1, 2],
  "failed": [
    {
      "reservationId": 3,
      "reason": "이미 취소된 예약입니다."
    }
  ]
}
```

> **참고**: FE 요청서의 `successCount`/`failCount` 형식과 다소 다름.
> BE는 성공/실패 ID 목록을 직접 반환하므로 count는 `success.length` / `failed.length`로 계산 가능.

### 상태 전이 규칙

| 현재 상태 | → CONFIRMED | → COMPLETED | → CANCELLED |
|----------|-------------|-------------|-------------|
| PENDING | O | X | O |
| CONFIRMED | - | O | O |
| COMPLETED | X | - | O |
| CANCELLED | X | X | - |

---

## 6. [P2] 통계 자동 새로고침 - 확인 완료

### 확인 결과

| 항목 | 결과 |
|------|------|
| Rate Limiting | **없음** - 통계 API에 rate limiting 미적용 |
| 5분 간격 호출 | **문제없음** - 인증된 사용자의 통상적 API 호출 |
| 캐싱 정책 | **없음** - 매 호출마다 실시간 DB 쿼리 |

### 통계 API 엔드포인트 (모두 rate limiting 없음)

| 엔드포인트 | 설명 |
|-----------|------|
| `GET /api/businesses/{id}/dashboard` | 메인 대시보드 |
| `GET /api/businesses/{id}/dashboard/stats` | 기간별 통계 |
| `GET /api/businesses/{id}/dashboard/goals` | 목표 달성률 |

> 모든 API가 `@Transactional(readOnly = true)`로 동작하며, 5분 간격 자동 새로고침에 영향 없음.

---

## 7. [미진행] 법률 문서 메타정보

FE 작업 영역. 실제 사업자 정보 제공 시 FE에서 일괄 반영 예정.

---

## 전체 변경 파일 목록

### 수정된 기존 파일 (7개)

| 파일 | 변경 내용 |
|------|----------|
| `common/config/WebConfig.java` | CORS 하드코딩 → 환경변수 사용 |
| `domain/business/BusinessSettings.java` | `vipSpendThreshold` 필드 추가 |
| `domain/business/dto/CustomerTierSettingsRequest.java` | `vipSpendThreshold` 필드 추가 |
| `domain/business/dto/CustomerTierSettingsResponse.java` | `vipSpendThreshold` 필드 추가 |
| `domain/business/service/BusinessService.java` | VIP 설정 조회/수정에 반영 |
| `domain/payment/service/PaymentService.java` | 일할계산 환불 로직 구현 |
| `resources/mapper/business/BusinessSettingsMapper.xml` | `vip_spend_threshold` 매핑 추가 |

### DB 스키마 변경 (1개)

| 파일 | 변경 내용 |
|------|----------|
| `resources/db/schema.sql` | `vip_spend_threshold` 컬럼 추가 |

---

## 배포 전 체크리스트

- [x] 빌드 성공 (`./gradlew compileJava`)
- [ ] **DB 마이그레이션**: `ALTER TABLE business_settings ADD COLUMN vip_spend_threshold DECIMAL(10,2) DEFAULT 500000;`
- [ ] 프로덕션 환경변수 설정 (`CORS_ALLOWED_ORIGINS`, `OAUTH2_REDIRECT_URI` 등)
- [ ] OAuth Provider 콘솔에서 yemo.kr 도메인 Redirect URI 등록
- [ ] 프론트엔드 일괄 상태 변경 API 경로 확인 (`/api/businesses/{businessId}/reservations/bulk-status`)
- [ ] PG 연동 시 VAT 포함 금액 저장 로직 추가 (환불 일할계산 연동)

---

## curl 테스트 예시

### VIP 설정 조회
```bash
curl -X GET http://localhost:8080/api/businesses/1/settings/customer-tiers \
  -H "Authorization: Bearer {TOKEN}"
```

### VIP 설정 수정 (vipSpendThreshold 포함)
```bash
curl -X PUT http://localhost:8080/api/businesses/1/settings/customer-tiers \
  -H "Authorization: Bearer {TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "regularThreshold": 3,
    "vipThreshold": 10,
    "vipSpendThreshold": 300000,
    "vipBenefitDescription": "VIP 고객 10% 할인"
  }'
```

### 예약 일괄 상태 변경
```bash
curl -X PATCH http://localhost:8080/api/businesses/1/reservations/bulk-status \
  -H "Authorization: Bearer {TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "reservationIds": [1, 2, 3],
    "status": "CONFIRMED"
  }'
```
