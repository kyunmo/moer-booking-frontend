# 백엔드 작업 완료 보고 (2026-02-22)

> 요청사항: [백엔드-요청사항-2026-02-22.md](./백엔드-요청사항-2026-02-22.md)

---

## 작업 요약

| # | 작업 | 상태 | 비고 |
|---|------|------|------|
| 1 | 유료 요금제 가격 변경 (18,000원/월) | **완료** | |
| 2 | 문의하기 API 신규 개발 | **완료** | 이메일 발송은 TODO |
| 3 | 매출/통계 TRIAL 접근 허용 | **완료** | |
| 4 | 기타 확인 사항 (기존 구독자 정책 등) | **확인 필요** | 아래 별도 정리 |

---

## 1. 유료 요금제 가격 변경

### 변경 파일
- `src/main/java/io/moer/booking/domain/business/SubscriptionPlan.java`

### 변경 내용

| 항목 | 기존 | 변경 |
|------|------|------|
| BASIC 월간 공급가액 | 20,000원 | **18,000원** |
| BASIC 연간 공급가액 | 200,000원 | **180,000원** |

```java
// 변경 전
BASIC("유료", 20000, 200000, 5, -1, -1);

// 변경 후
BASIC("유료", 18000, 180000, 5, -1, -1);
```

### 자동 반영 범위
`SubscriptionPlan.getPrice(BillingCycle)` 메서드를 사용하는 모든 곳에 자동 적용:
- `GET /api/subscription` → `monthlyPrice: 18000`, `yearlyPrice: 180000`
- `POST /api/payments` → 결제 금액 계산 시 18,000원/180,000원 기준
- 연간 결제 = 월 10개월분 (2개월 무료 혜택 유지)

### 참고
- 기존 결제 내역(payments 테이블)은 결제 시점 금액이 저장되어 있으므로 영향 없음
- 다음 결제부터 새 가격 자동 적용

---

## 2. 문의하기 API 신규 개발

### API 명세

```
POST /api/public/inquiries
```

**인증**: 불필요 (Public API)

### 요청

```json
{
  "name": "홍길동",
  "email": "example@email.com",
  "phone": "010-1234-5678",
  "type": "GENERAL",
  "content": "문의 내용..."
}
```

| 필드 | 타입 | 필수 | 검증 |
|------|------|------|------|
| name | String | O | @NotBlank, 최대 50자 |
| email | String | O | @NotBlank, @Email, 최대 100자 |
| phone | String | X | 최대 20자 |
| type | Enum | O | GENERAL, FEATURE_REQUEST, BUG_REPORT, PARTNERSHIP |
| content | String | O | @NotBlank, 최대 5,000자 |

### 응답

**성공 (201 Created)**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "message": "문의가 접수되었습니다."
  }
}
```

**Rate Limit 초과 (429 Too Many Requests)**
```json
{
  "success": false,
  "error": {
    "code": "IQ001",
    "message": "너무 많은 문의를 보내셨습니다. 잠시 후 다시 시도해주세요."
  }
}
```

### Rate Limiting
- IP당 최근 1시간 내 **5건** 제한
- DB 쿼리 기반 (inquiries 테이블에서 IP별 카운트)
- `X-Forwarded-For`, `X-Real-IP` 헤더 지원 (프록시/로드밸런서 환경)

### DB 스키마

```sql
CREATE TABLE inquiries (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    type VARCHAR(30) NOT NULL DEFAULT 'GENERAL',
    content TEXT NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    admin_note TEXT,
    ip_address VARCHAR(45),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

인덱스: `status`, `type`, `created_at DESC`, `ip_address`

### 생성된 파일 (9개)

| 레이어 | 파일 경로 |
|--------|----------|
| Entity | `domain/inquiry/Inquiry.java` |
| Enum | `domain/inquiry/InquiryType.java` |
| Enum | `domain/inquiry/InquiryStatus.java` |
| Request DTO | `domain/inquiry/dto/InquiryCreateRequest.java` |
| Response DTO | `domain/inquiry/dto/InquiryResponse.java` |
| Repository | `domain/inquiry/repository/InquiryRepository.java` |
| Mapper XML | `resources/mapper/inquiry/InquiryMapper.xml` |
| Service | `domain/inquiry/service/InquiryService.java` |
| Controller | `domain/inquiry/controller/InquiryController.java` |

### 미구현 (TODO)
- [ ] 관리자 이메일 알림 발송 (kkm@moer.io) → 이메일 서비스 구현 후 연동
- [ ] 문의자 접수 확인 이메일 발송 → 이메일 서비스 구현 후 연동
- [ ] 관리자용 문의 목록 조회/처리 API (SuperAdmin 영역)

---

## 3. 매출/통계 TRIAL 접근 허용

### 변경 파일
- `src/main/java/io/moer/booking/domain/subscription/service/SubscriptionCheckService.java`
- `src/main/java/io/moer/booking/common/exception/ErrorCode.java`

### 접근 제어 규칙 (변경 후)

| 구독 상태 | 통계 API 접근 | 에러 코드 |
|-----------|-------------|-----------|
| TRIAL (활성) | **허용** | - |
| PAID + ACTIVE | **허용** | - |
| EXPIRED (체험 만료) | 차단 | TR001 |
| FREE (무료 전환) | 차단 | TR002 |
| 기타 (만료/취소/정지) | 차단 | TR003 |

### `checkPremiumAccess()` 변경 내용

**변경 전**: TRIAL 상태 → TR002 에러 (차단)
```java
// 3. 체험 기간 중 유료 전용 기능 접근
if (status == SubscriptionStatus.TRIAL) {
    throw new BusinessException(ErrorCode.TRIAL_FEATURE_RESTRICTED,
            "체험판에서는 사용할 수 없는 기능입니다...");
}
```

**변경 후**: TRIAL 상태 → 통과 (허용)
```java
// 2. 체험 기간 중 → 모든 기능 허용
if (status == SubscriptionStatus.TRIAL) {
    return;
}
```

### 에러 메시지 변경

| 에러 코드 | 기존 메시지 | 변경 메시지 |
|-----------|-----------|-----------|
| TR002 | 체험판에서는 사용할 수 없는 기능입니다 | **무료 버전에서는 사용할 수 없는 기능입니다. 유료 플랜으로 업그레이드해주세요.** |

### 적용 범위
`checkPremiumAccess()` 메서드를 사용하는 모든 통계 API에 자동 적용:
- `GET /api/businesses/{id}/statistics/revenue`
- `GET /api/businesses/{id}/statistics/reservations`
- `GET /api/businesses/{id}/statistics/customers`
- `GET /api/businesses/{id}/statistics/staff`
- `GET /api/businesses/{id}/statistics/services`

---

## 4. 기타 확인 사항 (정책 결정 필요)

다음 항목은 비즈니스 정책 결정이 필요합니다:

| 항목 | 현재 상태 | 확인 필요 |
|------|----------|----------|
| 기존 유료 구독자 가격 | 다음 결제부터 자동 18,000원 적용 | 기존 가격 유지 정책 필요 여부 |
| 쿠폰 할인 | 현행 유지 | 가격 변경에 따른 할인율 조정 여부 |
| 환불 일할 계산 | 결제 시점 금액 기준 | 새 가격 반영 시점 확인 |
| 세금계산서 | 자동 반영 (18,000원 기준) | PG사 상품 금액 변경 필요 |

---

## 전체 변경 파일 목록

### 수정된 기존 파일 (3개)

| 파일 | 변경 내용 |
|------|----------|
| `domain/business/SubscriptionPlan.java` | BASIC 가격 20000→18000, 200000→180000 |
| `domain/subscription/service/SubscriptionCheckService.java` | TRIAL 접근 허용, 에러 메시지 변경 |
| `common/exception/ErrorCode.java` | TR002 메시지 변경, IQ001 추가 |

### 신규 생성 파일 (9개)

| 파일 | 설명 |
|------|------|
| `domain/inquiry/Inquiry.java` | 문의 엔티티 |
| `domain/inquiry/InquiryType.java` | 문의 유형 Enum |
| `domain/inquiry/InquiryStatus.java` | 문의 상태 Enum |
| `domain/inquiry/dto/InquiryCreateRequest.java` | 문의 생성 요청 DTO |
| `domain/inquiry/dto/InquiryResponse.java` | 문의 응답 DTO |
| `domain/inquiry/repository/InquiryRepository.java` | 문의 Repository |
| `resources/mapper/inquiry/InquiryMapper.xml` | MyBatis XML 매퍼 |
| `domain/inquiry/service/InquiryService.java` | 문의 서비스 |
| `domain/inquiry/controller/InquiryController.java` | 문의 컨트롤러 |

### DB 스키마 추가

| 파일 | 변경 내용 |
|------|----------|
| `resources/db/schema.sql` | inquiries 테이블 + 4개 인덱스 추가 |

---

## 배포 전 체크리스트

- [x] 빌드 성공 (`./gradlew compileJava`)
- [ ] **DB 마이그레이션**: inquiries 테이블 생성 스크립트 실행
- [ ] 프론트엔드 연동 테스트 (문의하기 모달)
- [ ] Rate Limiting 동작 확인 (IP당 5건/시간)
- [ ] 통계 API TRIAL 접근 테스트
- [ ] 가격 변경 확인 (구독 정보 API 응답)

---

## curl 테스트 예시

### 문의하기 API
```bash
curl -X POST http://localhost:8080/api/public/inquiries \
  -H "Content-Type: application/json" \
  -d '{
    "name": "홍길동",
    "email": "test@example.com",
    "phone": "010-1234-5678",
    "type": "GENERAL",
    "content": "서비스 이용 문의드립니다."
  }'
```

### 구독 정보 조회 (가격 확인)
```bash
curl -X GET http://localhost:8080/api/subscription \
  -H "Authorization: Bearer {TOKEN}"
```

예상 응답: `monthlyPrice: 18000`, `yearlyPrice: 180000`
