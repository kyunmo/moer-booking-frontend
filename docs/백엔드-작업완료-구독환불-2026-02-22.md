# 백엔드 작업 완료 보고 - 구독 정보 표시 + 환불 미리보기 (2026-02-22)

> 요청사항: [백엔드-요청사항-구독환불-2026-02-22.md](./백엔드-요청사항-구독환불-2026-02-22.md)

---

## 작업 요약

| # | 우선순위 | 작업 | 상태 | 비고 |
|---|---------|------|------|------|
| 1 | P1 | 슈퍼어드민 매장 목록 구독 필드 + 필터 | **완료** | BusinessResponse 확장 |
| 2 | P1 | 슈퍼어드민 매장 상세 조회 API | **완료** | 신규 엔드포인트 추가 |
| 3 | P2 | 환불 미리보기 API | **완료** | 7일 이내 전액 환불 정책 포함 |

---

## 1. [P1] GET /api/superadmin/businesses 응답 확장

### 변경 내용

**BusinessResponse에 구독 필드 5개 추가:**

```json
{
  "id": 1,
  "name": "매장명",
  "businessType": "BEAUTY_SHOP",
  "ownerName": "홍길동",
  "status": "ACTIVE",
  "createdAt": "2026-01-15 10:00:00",
  "subscriptionPlan": "BASIC",
  "subscriptionStatus": "ACTIVE",
  "billingCycle": "MONTHLY",
  "nextBillingDate": "2026-03-15 00:00:00",
  "isTrialActive": false
}
```

**필터 파라미터 2개 추가:**

| 파라미터 | 타입 | 설명 | 예시 |
|---------|------|------|------|
| `planType` | String | 구독 플랜 필터 | `FREE`, `BASIC` |
| `subscriptionStatus` | String | 구독 상태 필터 | `ACTIVE`, `TRIAL`, `EXPIRED`, `CANCELED` |

### 변경 파일 (4개)

| 파일 | 변경 내용 |
|------|----------|
| `domain/business/dto/BusinessResponse.java` | `subscriptionPlan`, `subscriptionStatus`, `billingCycle`, `nextBillingDate`, `isTrialActive` 필드 추가 |
| `domain/business/dto/BusinessSearchCondition.java` | `planType`, `subscriptionStatus` 필터 필드 추가 |
| `resources/mapper/business/BusinessMapper.xml` | `findAll`, `countAll` 쿼리에 구독 필터 조건 추가 |

### curl 테스트

```bash
# 전체 매장 조회 (구독 필드 포함)
curl -X GET "http://localhost:8080/api/superadmin/businesses?page=1&size=20" \
  -H "Authorization: Bearer {TOKEN}"

# 유료 플랜 매장만 필터
curl -X GET "http://localhost:8080/api/superadmin/businesses?planType=BASIC" \
  -H "Authorization: Bearer {TOKEN}"

# 체험판 매장만 필터
curl -X GET "http://localhost:8080/api/superadmin/businesses?subscriptionStatus=TRIAL" \
  -H "Authorization: Bearer {TOKEN}"

# 복합 필터 (유료 + 활성)
curl -X GET "http://localhost:8080/api/superadmin/businesses?planType=BASIC&subscriptionStatus=ACTIVE" \
  -H "Authorization: Bearer {TOKEN}"
```

---

## 2. [P1] GET /api/superadmin/businesses/{id} 상세 조회

### 변경 내용

**신규 엔드포인트** 추가. 구독 상세 정보 + 최근 결제 내역(최대 10건) 포함.

### 응답 구조

```json
{
  "id": 1,
  "name": "매장명",
  "businessType": "BEAUTY_SHOP",
  "ownerName": "홍길동",
  "ownerEmail": "owner@example.com",
  "address": "서울시 강남구...",
  "addressDetail": "2층",
  "zipCode": "06234",
  "status": "ACTIVE",
  "profileImageUrl": null,
  "businessHours": { "mon": { "open": "09:00", "close": "20:00" } },
  "createdAt": "2026-01-15 10:00:00",
  "subscription": {
    "plan": "BASIC",
    "status": "ACTIVE",
    "billingCycle": "MONTHLY",
    "startDate": "2026-01-15",
    "nextBillingDate": "2026-03-15",
    "trialEndDate": null,
    "isTrialActive": false,
    "currentStaffCount": 3,
    "maxStaff": 5,
    "currentMonthReservationCount": 45,
    "maxMonthlyReservations": -1
  },
  "recentPayments": [
    {
      "id": 101,
      "amount": 18000,
      "status": "COMPLETED",
      "createdAt": "2026-02-15 09:00:00",
      "subscriptionPlan": "BASIC",
      "paymentMethod": "CARD"
    }
  ]
}
```

### 변경 파일 (4개)

| 파일 | 변경 내용 |
|------|----------|
| `domain/superadmin/dto/SuperAdminBusinessDetailResponse.java` | **신규** - 상세 응답 DTO (SubscriptionDetail, RecentPayment 내부 클래스 포함) |
| `domain/superadmin/service/SuperAdminBusinessService.java` | `getBusinessDetail()` 메서드 추가 |
| `domain/superadmin/controller/SuperAdminBusinessController.java` | `GET /{id}` 엔드포인트 추가 |
| `domain/payment/repository/PaymentRepository.java` | `findRecentByBusinessId()` 메서드 추가 |
| `resources/mapper/PaymentMapper.xml` | `findRecentByBusinessId` 쿼리 추가 |

### curl 테스트

```bash
curl -X GET http://localhost:8080/api/superadmin/businesses/1 \
  -H "Authorization: Bearer {TOKEN}"
```

---

## 3. [P2] GET /api/payments/{paymentId}/refund-preview

### 변경 내용

**신규 엔드포인트**. 환불 전 예상 금액 미리보기.

### 응답 구조

```json
{
  "paymentId": 101,
  "originalAmount": 19800,
  "refundAmount": 13200,
  "usedDays": 10,
  "remainingDays": 20,
  "totalDays": 30,
  "usagePercent": 33,
  "isFullRefund": false,
  "formula": "19,800원 x (20일 / 30일)"
}
```

### 환불 계산 로직 (7일 이내 전액 환불 정책 추가)

```
1. 결제 당일 → 전액 환불
2. 7일 이내 → 전액 환불 (신규 정책)
3. 기간 만료 → 0원
4. 그 외 → finalAmount × (잔여일수 / 총일수) (반올림)
```

### 환불 예시 (월간 19,800원, 30일 기준)

| 사용 기간 | 잔여일 | 환불 금액 | formula |
|----------|--------|----------|---------|
| 당일 | 30일 | 19,800원 | "19,800원 (결제 당일 전액 환불)" |
| 3일 | 27일 | 19,800원 | "19,800원 (7일 이내 전액 환불)" |
| 7일 | 23일 | 19,800원 | "19,800원 (7일 이내 전액 환불)" |
| 10일 | 20일 | 13,200원 | "19,800원 x (20일 / 30일)" |
| 20일 | 10일 | 6,600원 | "19,800원 x (10일 / 30일)" |
| 25일 | 5일 | 3,300원 | "19,800원 x (5일 / 30일)" |
| 만료 후 | 0일 | 0원 | "0원 (청구 기간 만료)" |

### 변경 파일 (3개)

| 파일 | 변경 내용 |
|------|----------|
| `domain/payment/dto/RefundPreviewResponse.java` | **신규** - 환불 미리보기 응답 DTO |
| `domain/payment/service/PaymentService.java` | `getRefundPreview()` 추가, `calculateProRataRefund()` 7일 전액환불 정책 추가 |
| `domain/payment/controller/PaymentController.java` | `GET /{paymentId}/refund-preview` 엔드포인트 추가 |

### curl 테스트

```bash
curl -X GET http://localhost:8080/api/payments/101/refund-preview \
  -H "Authorization: Bearer {TOKEN}"
```

---

## ⚠️ 주요 변경사항 알림

### 기존 환불 로직 변경

`calculateProRataRefund()` 메서드에 **7일 이내 전액 환불 정책**이 추가되었습니다.

**변경 전:**
- 결제 당일 → 전액 환불
- 그 외 → 일할 계산

**변경 후:**
- 결제 당일 → 전액 환불
- **7일 이내 → 전액 환불 (신규)**
- 그 외 → 일할 계산

> 이 변경은 `refundPayment()` (실제 환불)과 `getRefundPreview()` (미리보기) 모두에 동일하게 적용됩니다.

### BusinessResponse 확장

기존 매장 조회 API(일반 사용자용 포함)에도 구독 필드가 포함됩니다.
- `subscriptionPlan`, `subscriptionStatus`, `billingCycle`, `nextBillingDate`, `isTrialActive`
- 구독 정보는 민감하지 않으며, 매장 소유자가 자신의 구독 상태를 확인하는 데 유용합니다.

---

## 전체 변경 파일 목록

### 신규 파일 (2개)

| 파일 | 설명 |
|------|------|
| `domain/superadmin/dto/SuperAdminBusinessDetailResponse.java` | 슈퍼어드민 매장 상세 응답 DTO |
| `domain/payment/dto/RefundPreviewResponse.java` | 환불 미리보기 응답 DTO |

### 수정 파일 (8개)

| 파일 | 변경 내용 |
|------|----------|
| `domain/business/dto/BusinessResponse.java` | 구독 필드 5개 추가 |
| `domain/business/dto/BusinessSearchCondition.java` | 구독 필터 2개 추가 |
| `resources/mapper/business/BusinessMapper.xml` | findAll/countAll에 구독 필터 조건 추가 |
| `domain/superadmin/controller/SuperAdminBusinessController.java` | GET /{id} 엔드포인트 추가 |
| `domain/superadmin/service/SuperAdminBusinessService.java` | getBusinessDetail() 메서드 추가 |
| `domain/payment/controller/PaymentController.java` | GET /{paymentId}/refund-preview 추가 |
| `domain/payment/service/PaymentService.java` | getRefundPreview() + 7일 전액환불 정책 |
| `domain/payment/repository/PaymentRepository.java` | findRecentByBusinessId() 추가 |
| `resources/mapper/PaymentMapper.xml` | findRecentByBusinessId 쿼리 추가 |

---

## 프론트엔드 연동 가이드

### 1. 매장 목록 (기존 API 확장)
- 기존 `GET /api/superadmin/businesses` 호출 시 자동으로 구독 필드 포함
- 필터 추가: `?planType=BASIC&subscriptionStatus=ACTIVE`
- **별도 수정 불필요** (응답 필드 확장만)

### 2. 매장 상세 (신규 API)
- **기존**: 매장 상세 조회 API 없었음 (SuperAdmin 전용)
- **신규**: `GET /api/superadmin/businesses/{id}`
- FE `fetchBusinessDetail()` 호출 대상

### 3. 환불 미리보기 (신규 API)
- `GET /api/payments/{paymentId}/refund-preview`
- FE `getRefundPreview()` 호출 대상
- **API 제공 후에도 FE fallback 유지 권장** (네트워크 오류 시)

---

## 배포 전 체크리스트

- [x] 빌드 성공 (`./gradlew compileJava`)
- [ ] DB 마이그레이션 불필요 (스키마 변경 없음)
- [ ] 프론트엔드 매장 목록 필터 UI 연동 확인
- [ ] 프론트엔드 매장 상세 다이얼로그 API 연동 확인
- [ ] 프론트엔드 환불 미리보기 API 연동 확인 (fallback 병행)
